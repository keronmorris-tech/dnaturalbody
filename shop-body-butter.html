<script>
(function(){
  const SHOP_CART_ADD = "https://shop.dnaturalbody.com/cart/add";
  const drawer = document.getElementById("cartDrawer");
  const overlay = document.getElementById("cartOverlay");
  const frame = document.getElementById("cartFrame");
  const addFrame = document.getElementById("cartAddFrame");

  function getVariantId(){
    const active = document.querySelector('.size-option.active[data-variant]');
    if (active) return active.getAttribute('data-variant');
    const first = document.querySelector('.size-option[data-variant]');
    if (first) return first.getAttribute('data-variant');

    const btn = document.getElementById('addToCartBtn');
    if (btn && btn.getAttribute('data-variant')) return btn.getAttribute('data-variant');

    return null;
  }

  function refreshCart(){
    frame.src = "https://shop.dnaturalbody.com/cart?view=drawer&t=" + Date.now();
  }

  function openCart(){
    overlay.style.display = "block";
    drawer.style.right = "0";
    refreshCart();
  }

  function closeCart(){
    overlay.style.display = "none";
    drawer.style.right = "-420px";
  }

  function wireSizeButtons(){
    document.querySelectorAll('.size-option[data-variant]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.size-option').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');

        const price = btn.getAttribute('data-price');
        const size = btn.getAttribute('data-size');
        const grams = btn.getAttribute('data-grams');
        const priceEl = document.getElementById('priceText');
        const sizeEl = document.getElementById('sizeText');
        if (price && priceEl) priceEl.textContent = `$${parseFloat(price).toFixed(2)}`;
        if (sizeEl && size && grams) sizeEl.textContent = `Net Wt. ${size} / ${grams} g`;
      });
    });
  }

  function wireAddToCart(){
    const btn = document.getElementById('addToCartBtn');
    if (!btn) return;

    btn.addEventListener('click', ()=>{
      const variantId = getVariantId();
      if (!variantId){
        alert("Couldn't find the selected size/variant.");
        return;
      }

      // Add to Shopify cart WITHOUT leaving the page (reliable cross-subdomain method)
      // This will update Shopify cart + inventory, then we open drawer + refresh the cart view.
      addFrame.onload = function(){
        openCart();
        addFrame.onload = null;
      };

      addFrame.src = `${SHOP_CART_ADD}?id=${encodeURIComponent(variantId)}&quantity=1&return_to=%2Fcart%3Fview%3Ddrawer`;
    });
  }

  function wireCartIcon(){
    const cartBtn = document.getElementById('cartButton');
    if (!cartBtn) return;
    cartBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      openCart();
    });
  }

  document.getElementById("closeCart")?.addEventListener("click", closeCart);
  overlay?.addEventListener("click", closeCart);

  document.addEventListener('DOMContentLoaded', ()=>{
    wireSizeButtons();
    wireAddToCart();
    wireCartIcon();
  });
})();
</script>
